## Validation Report: Spec 021 — Content Rewrite Plugin (COMPLETE)
**Date**: 2026-02-22 21:30
**Commits**: 18fe777, 5770c94, 1583637
**Specs**: 021
**Status**: PASSED

### Summary

Spec 021 introduced user-defined content rewrite rules with plugin chaining,
REST API, dashboard UI, and proxy restart support. A follow-up fix added
content-type filtering and HTML-safe replacement after live testing revealed
that blind global replacement broke Reddit's JSON API responses and inline
JavaScript.

### Implementation Scope (27 files, ~2900 lines added)

**Core plugin**: `internal/plugin/rewrite.go` — ContentFilter implementation
with literal and regex replacement, per-rule domain/URL/content-type scoping,
HTML-safe replacement (skips `<script>` and `<style>` blocks)

**Persistence**: `internal/plugin/rewrite_store.go` — SQLite-backed rule CRUD
with WAL mode, schema migration for content_types column

**Plugin chaining**: `internal/plugin/registry.go` — priority-ordered
multi-plugin execution per domain via `BuildResponseModifier`

**REST API**: `web/handlers_rewrite.go` — CRUD endpoints, toggle, pattern
test, hot-reload callback

**Dashboard UI**: `web/ui/src/components/RewriteRules.tsx`, `web/ui/src/pages/Config.tsx`
— sub-tab config layout, rule CRUD form, enable toggle, live pattern tester,
content type configuration

**Proxy restart**: `POST /fps/api/restart` via systemd, guarded by
INVOCATION_ID check, confirmation dialog in UI

### Phase 3: Tests
- Test suite: `make test` (go test -race -short -v ./...)
- Results: 250 passing, 0 failing
- New tests added by spec 021: 51
  - 30 rewrite filter tests (literal, regex, domain/URL scoping, content-type
    filtering, HTML protected ranges, multi-rule chaining)
  - 5 rewrite store tests (CRUD, content_types round-trip, default empty)
  - 9 plugin chaining tests (priority ordering, multi-plugin execution,
    duplicate priority rejection)
  - 7 handler tests (API CRUD, validation, toggle, pattern test, not-found)
- Status: PASSED

### Phase 4: Code Quality
- Dead code: None found
- Duplication: `selectColumns` constant extracted for DRY SQL column lists;
  `isInProtectedRange` shared by literal and regex HTML-safe replacers
- Encapsulation: Plugin chaining isolated in registry.go; rewrite store
  self-contained with sync.Mutex; protected range logic separated from
  filter dispatch; handler layer in dedicated handlers_rewrite.go
- Status: PASSED

### Phase 5: Security Review
- Dependencies: No new external dependencies (zombiezen sqlite already in use)
- SQL injection: All queries use parameterized args via zombiezen ExecOptions
- Regex DoS: Go RE2 engine guarantees linear-time matching
- Input validation: Pattern compilation on create/update; name length limit
  (200 chars); content-type strings normalized and lowered
- Restart endpoint: Guarded by INVOCATION_ID env var; uses exec.Command with
  separate args (no shell injection); requires authentication
- OWASP: No hardcoded secrets, no path traversal, session auth on all API
  endpoints
- Status: PASSED

### Phase 5.5: Release Safety
- Change type: Code + UI + config schema + SQLite schema migration
- Backward compatibility: New `priority` field defaults to 100; existing
  configs work unchanged; rewrite plugin is opt-in; content_types column
  migration is additive (ALTER TABLE ADD COLUMN); empty content_types
  defaults to safe set (text/html, text/plain)
- Rollback plan: Revert commits, remove rewrite section from fpsd.yml,
  restart service; SQLite column addition is harmless if code reverted
- Status: PASSED

### Acceptance Criteria Status

All 42 acceptance criteria from spec 021 are met. Key items verified:

- Plugin chaining with priority ordering (reddit-promotions:100, rewrite:900)
- Literal and regex replacement with capture groups
- Per-rule domain, URL pattern, and content-type scoping
- SQLite persistence with WAL mode, hot-reload on CRUD
- Full REST API with auth, validation (400/404 errors), toggle
- Dashboard config sub-tabs, rule CRUD form, pattern tester
- Proxy restart via systemd with UI confirmation dialog
- Stats integration (inspected/matched/modified/per-rule counts)
- Content-type safety: JSON/JS responses pass through unmodified
- HTML safety: script/style blocks preserved during replacement

### Known Limitations

- Replacements still occur inside HTML attributes (e.g., href values).
  Fixing this requires an HTML tokenizer; deferred to future work.
- `[T|t]` in character class matches literal `|` — user regex error,
  not a code bug

### Overall
- All gates passed: YES
- Lint: 0 issues (golangci-lint v2.9.0)
- Live tested: rewrite rules applied to Reddit traffic via transparent proxy;
  reddit-promotions and rewrite plugins chain correctly; JSON API responses
  and inline scripts are not corrupted
